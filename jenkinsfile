node {
    stage('Install dependencies') {
        sh """
        pwd
        sudo apt install -y python3-pip
        pip3 install google-cloud-pubsub
        pip3 install google-cloud-storage
        pip3 install google-api-core
        pip3 install google-cloud-bigquery
        pip3 install pybase64
        """
    }
    stage('Git Clone') {
        sh """
        pwd
        rm -rf hello_world_flask
        git clone https://github.com/Siilvaaz/hello_world_flask -b main
        ls -lart
        """
    }
    stage('Get Input from GCS') {
        sh """
        pwd
        cd hello_world_flask
        python3 Get_Payload.py sandbox-anthos hello_world_flask pocjenkins input.json
        """
    }
    stage('Get Expected Output payload from GCS') {
        sh """
        pwd
        cd hello_world_flask
        python3 Get_Payload.py sandbox-anthos hello_world_flask pocjenkins expected_output.json
        """
    }
    stage('Publish to PubSub') {
        sh """
        pwd
        cd hello_world_flask
        python3 PubSub_Publisher.py sandbox-anthos jenkins_poc input.json
        ls -l
        echo "### pubsub message id ###"
        cat pubsub_ack.txt
        """
    }
    stage('Listen to PubSub') {
        sh """
        pwd
        cd hello_world_flask
        python3 PubSub_Listener.py sandbox-anthos jenkins_poc-sub received_payload.json
        ls -l
        """
    }
    stage('Compare Payloads') {
        sh """
        pwd
        cd hello_world_flask
        python3 Verify_Payload.py sandbox-anthos expected_output.json received_payload.json
        """
    }
}
